#!/bin/sh

set -e

#PREFIX=i686-w64-mingw32
PREFIX=x86_64-w64-mingw32
export CC=$PREFIX-gcc
export CXX=$PREFIX-g++
export CPP=$PREFIX-cpp
export RANLIB=$PREFIX-ranlib
export PATH="/usr/$PREFIX/bin:$PATH"

export INSTALLDIR="/usr/local/$PREFIX"
export PKG_CONFIG_PATH=$INSTALLDIR/lib/pkgconfig:/usr/$PREFIX/lib/pkgconfig
export CPPFLAGS="-I$INSTALLDIR/include"
export LDFLAGS="-L$INSTALLDIR/lib"

# let mingw compiler be less verbose
export CFLAGS="-O2 -Wall -Wno-format"

# Install Libmicrohttpd from source
if [ ! -d libmicrohttpd ]; then
  git clone --recursive https://gnunet.org/git/libmicrohttpd.git
  cd libmicrohttpd
else
  cd libmicrohttpd
  git pull
fi
./bootstrap
./configure --build=x86_64-pc-linux-gnu --host=$PREFIX --prefix=$INSTALLDIR --disable-doc --disable-examples --enable-shared --enable-static
make clean
make -j$(nproc)
sudo make install
cd ..

# compile & install dependencies first (example: libidn)
# apt-get source libidn
# cd libidn-*
# ./configure --host=$PREFIX
# make
# sudo make install
# rm -rf libidn-*

export WINEPATH="$INSTALLDIR/bin;$INSTALLDIR/lib;/usr/$PREFIX/bin;/usr/$PREFIX/lib;$HOME/src/wget2/libwget/.libs"
./bootstrap
./configure --build=x86_64-pc-linux-gnu --host=$PREFIX --enable-shared --enable-static
make clean
make -j$(nproc)
make check -j$(nproc) LOG_COMPILER=wine

# Alternatively, add the library path for wine in ~/.wine/system.reg:
# search for
#   [System\\CurrentControlSet\\Control\\Session Manager\\Environment]
# within this section you'll find a PATH variable
#   "PATH"=str(2):"C:\\windows\\system32;C:\\windows;C:\\windows\\system32\\wbem"
# add your path like e.g.
#   "PATH"=str(2):"C:\\windows\\system32;C:\\windows;C:\\windows\\system32\\wbem;Z:\\usr\\x86_64-w64-mingw32\\lib"
#
# Now wine is able to find the mingw DLLs.
